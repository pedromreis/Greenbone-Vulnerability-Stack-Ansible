#!/usr/bin/env bash

set -e

# default - vars
STAGE="stable"
[ -z "${BUILD}" ] && BUILD="-20200613"

# build gvmlibs
echo "
################################################################################
################### Build gvmlibs ##############################################
################################################################################"
gvmlibs_version=11.0
build_gvmlibs="${BUILD}"
docker build -f ./Dockerfile-gvmlibs --build-arg STAGE=${STAGE} \
  -t "securecompliance/gvmlibs:${gvmlibs_version}${build_gvmlibs}" \
  -t "securecompliance/gvmlibs:latest" .

# build gvmd
echo "
################################################################################
################### Build gvmd #################################################
################################################################################"
gvmd_version=9.0
build_gvmd="${BUILD}"
docker build -f ./Dockerfile-gvmd --build-arg STAGE=${STAGE} \
  -t "securecompliance/gvmd:${gvmd_version}${build_gvmd}" \
  -t "securecompliance/gvmd:latest" .

# build openvas
echo "
################################################################################
################### Build openvas ##############################################
################################################################################"
openvas_version=7.0
build_openvas="${BUILD}"
docker build -f ./Dockerfile-openvas --build-arg STAGE=${STAGE} \
  -t "securecompliance/openvas:${openvas_version}${build_openvas}" \
  -t "securecompliance/openvas:latest" .

# build gsa
echo "
################################################################################
################### Build gsa ##################################################
################################################################################"
gsa_version=9.0
build_gsa="${BUILD}"
docker build -f ./Dockerfile-gsa --build-arg STAGE=${STAGE} \
  -t "securecompliance/gsa:${gsa_version}${build_gsa}" \
  -t "securecompliance/gsa:latest" .

# build postgres
echo "
################################################################################
################### Build postgres #############################################
################################################################################"
postgres_version=9.6
build_postgres="${BUILD}"
docker build -f ./Dockerfile-postgres --build-arg STAGE=${STAGE} \
  -t "securecompliance/postgres:${postgres_version}${build_postgres}" \
  -t "securecompliance/postgres:latest" .

postgres_gvm_version=9.6
build_postgres_gvm="${BUILD}"
docker build -f ./Dockerfile-postgres-gvm --build-arg STAGE=${STAGE} \
  -t "securecompliance/postgres-gvm:${postgres_gvm_version}${build_postgres_gvm}" \
  -t "securecompliance/postgres-gvm:latest" .

# push
if [ "${1}" == "push" ]; then
  docker push "securecompliance/gvmlibs:${gvmlibs_version}${build_gvmlibs}"
  docker push "securecompliance/gvmlibs:latest"

  docker push "securecompliance/gvmd:${gvmd_version}${build_gvmd}"
  docker push "securecompliance/gvmd:latest"

  docker push "securecompliance/openvas:${openvas_version}${build_openvas}"
  docker push "securecompliance/openvas:latest"

  docker push "securecompliance/gsa:${gsa_version}${build_gsa}"
  docker push "securecompliance/gsa:latest"

  docker push "securecompliance/postgres:${postgres_version}${build_postgres}"
  docker push "securecompliance/postgres:latest"

  docker push "securecompliance/postgres-gvm:${postgres_gvm_version}${build_postgres_gvm}"
  docker push "securecompliance/postgres-gvm:latest"
fi
